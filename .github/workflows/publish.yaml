name: Build, Test, Publish, Release (Windows Desktop)

on:
  push:
    branches: ["main"]
    tags:
      - "v*"
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-test-publish:
    runs-on: windows-latest

    env:
      CONFIGURATION: Release
      RUNTIME: win-x64

      SOLUTION: StlOrganizer.sln
      GUI_PROJECT: src/StlOrganizer.Gui/StlOrganizer.Gui.csproj

      # Persistent build counter in repo
      BUILD_COUNTER_FILE: .github/build-number.txt

      # Staging dirs inside the runner workspace
      STAGING_DIR: artifacts/staging
      ZIP_PATH: artifacts/StlOrganizer-win-x64-${{ env.VERSION }}.zip

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      # For tags: bump persisted counter on main, then return to the tag commit and set VERSION=1.0.0.BUILDNUMBER
      # For non-tags: set VERSION=0.0.0.<run_number> (so builds still have a version)
      - name: Set version (tag = persisted revision)
        shell: pwsh
        run: |
          $isTag = $env:GITHUB_REF -like 'refs/tags/*'

          if ($isTag) {
            $tagName = $env:GITHUB_REF_NAME          # e.g. v1.0.0
            $baseVersion = $tagName.TrimStart('v')   # e.g. 1.0.0
            $tagSha = $env:GITHUB_SHA

            # Switch to main, bump counter, commit, push
            git checkout main
            git pull --rebase origin main

            $counterFile = "${{ env.BUILD_COUNTER_FILE }}"
            if (-not (Test-Path $counterFile)) {
              New-Item -ItemType Directory -Force -Path (Split-Path $counterFile) | Out-Null
              Set-Content -Path $counterFile -Value "0" -NoNewline
            }

            $raw = (Get-Content $counterFile -Raw).Trim()
            if ($raw -notmatch '^\d+$') {
              throw "Build counter file must contain only an integer. Found: '$raw'"
            }

            $buildNumber = ([int]$raw) + 1
            Set-Content -Path $counterFile -Value $buildNumber -NoNewline

            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add $counterFile
            git commit -m "chore: bump build number to $buildNumber" | Out-Null
            git push origin main

            # Return to the exact tag commit for build/publish
            git checkout $tagSha

            $version = "$baseVersion.$buildNumber"

            "BASE_VERSION=$baseVersion" | Out-File -FilePath $env:GITHUB_ENV -Append
            "BUILD_NUMBER=$buildNumber" | Out-File -FilePath $env:GITHUB_ENV -Append
            "VERSION=$version"          | Out-File -FilePath $env:GITHUB_ENV -Append
          }
          else {
            $baseVersion = "0.0.0"
            $buildNumber = $env:GITHUB_RUN_NUMBER
            $version = "$baseVersion.$buildNumber"

            "BASE_VERSION=$baseVersion" | Out-File -FilePath $env:GITHUB_ENV -Append
            "BUILD_NUMBER=$buildNumber" | Out-File -FilePath $env:GITHUB_ENV -Append
            "VERSION=$version"          | Out-File -FilePath $env:GITHUB_ENV -Append
          }

      - name: Restore
        run: dotnet restore "${{ env.SOLUTION }}"

      - name: Build (stamped)
        run: >
          dotnet build "${{ env.SOLUTION }}"
          -c ${{ env.CONFIGURATION }}
          --no-restore
          /p:Version=${{ env.VERSION }}
          /p:AssemblyVersion=${{ env.BASE_VERSION }}
          /p:FileVersion=${{ env.VERSION }}
          /p:InformationalVersion=${{ env.VERSION }}

      # Runs ALL tests in the solution; fails if any test fails.
      - name: Test (all)
        run: dotnet test "${{ env.SOLUTION }}" -c ${{ env.CONFIGURATION }} --no-build --logger "trx;LogFileName=test-results.trx"

      - name: Publish (self-contained, stamped)
        run: >
          dotnet publish "${{ env.GUI_PROJECT }}"
          -c ${{ env.CONFIGURATION }}
          -r ${{ env.RUNTIME }}
          --self-contained true
          -o "${{ env.STAGING_DIR }}"
          /p:PublishSingleFile=true
          /p:IncludeNativeLibrariesForSelfExtract=true
          /p:DebugType=None
          /p:DebugSymbols=false
          /p:Version=${{ env.VERSION }}
          /p:AssemblyVersion=${{ env.BASE_VERSION }}
          /p:FileVersion=${{ env.VERSION }}
          /p:InformationalVersion=${{ env.VERSION }}

      - name: Add README to package
        shell: pwsh
        run: |
          Copy-Item "README.md" "${{ env.STAGING_DIR }}\README.md" -Force

      - name: Create zip
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path (Split-Path "${{ env.ZIP_PATH }}") | Out-Null
          if (Test-Path "${{ env.ZIP_PATH }}") { Remove-Item "${{ env.ZIP_PATH }}" -Force }
          Compress-Archive -Path "${{ env.STAGING_DIR }}\*" -DestinationPath "${{ env.ZIP_PATH }}"

      - name: Upload packaged zip (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: StlOrganizer-${{ env.RUNTIME }}-${{ env.VERSION }}-selfcontained
          path: ${{ env.ZIP_PATH }}

      - name: Upload test results (TRX)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: "**/*.trx"

      # Create a GitHub Release + attach the zip when building a tag like v1.2.3
      - name: Create GitHub Release (tags only)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          name: StlOrganizer ${{ env.VERSION }}
          files: ${{ env.ZIP_PATH }}
          generate_release_notes: true
